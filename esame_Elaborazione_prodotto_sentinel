library(raster)
library(rgdal)
library(scales)

#path to folder

folder <- "C:\\tel21\\S2B_MSIL1C_20230107T090249_N0509_R007_T35SMD_20230107T093527.SAFE\\GRANULE\\L1C_T35SMD_A030492_20230107T090326\\IMG_DATA\\"
final_prod_name <- "C:\\tel21\\data_ok\\2023_w.tif"

# Importa tutte le bande in una lista

bands <- list.files(folder, pattern = "*.jp2$", full.names = TRUE)

# Legge le bande con risoluzione originale

rasters <- lapply(bands, raster)

#-->ciclo for per scorrere attraverso la lista di bande e applicare la funzione resample ad ogni banda singolarmente

rasters_resampled <- list()
for (i in 1:length(rasters)) {
  rasters_resampled[[i]] <- resample(rasters[[i]], rasters[[3]], res = 10)
}

# Unisce tutte le bande in un unico file raster

raster_brick <- brick(rasters_resampled)

#upload raster maskera, applica maschera, crop su no useful part

mask_shapefile <- readOGR("C:\\tel21\\ROI\\ROI_LES.shp")
masked_raster <- mask(raster_brick , mask_shapefile)
masked_crop <- crop(masked_raster, mask_shapefile)

#n normalizza valori rifl band tra 0 e 1  
#salvati prodotti pronti a uso

masked_crop_norm <- (masked_crop-min(masked_crop))/(max(masked_crop)-min(masked_crop))
writeRaster(masked_crop_norm, filename = final_prod_name, format = "GTiff")

#verifica riuscita
print(masked_crop_norm)
plot(masked_crop_norm)




